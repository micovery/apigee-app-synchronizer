## Apigee Developer App Synchronizer

This repo contains a sample Cloud Run that is triggered whenever a new Developer Application
is created or Updated in an Apigee X organization.

Upon creation or update of a `Developer Application`, the Cloud Run connects to a Keycloak Identity Provider realm, and creates
a KeyCloak `client` with a matching `client_id` and `client_secret`.

This is useful if you are using the KeyCloak Identity Provider to manage both the end user identity, and application identity.

In this case, it is typical for applications to interact directly with the Identity Provider to get access tokens (without going through Apigee).

The access tokens generated by the KeyCloak Identity Provider contain the application's `client_id` as a claim. 
The `client_id` can then be accessed and validated within the API Proxies in Apigee X. 
This is, in addition to validating the signature of the Identity Provider access token

If you are using the [Identity Provider facade pattern](https://github.com/apigee/devrel/tree/main/references/identity-facade), it is not necessary to synchronize apps.
That is because the facade pattern instead uses a single app in Apigee to interact with the Identity Provider.


## Prerequisites

 * Terraform v1.5.7 or later


## Deploy Keycloak Instance

If you do not already have a Keycloak instance, you can use the following script to create one in your GCP project.

This script uses terraform create a new Compute Engine VM, and installs Keycloak in it. Then, it creates
a load balancer, and points it to the VM.

```shell
export PROJECT_ID="YOUR_GPC_PROJECT"
export REGION="us-west2"
export ZONE="us-west2-a"
export VPC_NAME="default"
export VPC_SUBNET="default"
export KEYCLOAK_ADMIN="admin"
export KEYCLOAK_ADMIN_PASSWORD="SuperSecret123"
./deploy-keycloak.sh
```

## Setup Keycloak Instance

* Get the Keycloak URI

    ```shell
    export KEYCLOAK_URI="https://$(gcloud compute forwarding-rules describe keycloak-idp-instance-fwd-rule --global --format='value(IPAddress)').nip.io"
    echo $KEYCLOAK_URI
    ```

* Navigate to the Keycloak URI (above), then open the Admin Console and log in.


* Create a new `realm`, named **apigee**. This `realm` will contain the synchronized clients.



## Deploy Cloud Run Synchronizer

Once you have a Keycloak instance, you can create the Cloud Run that will synchronize 
Apigee X Developer Apps with Keycloak clients.

First, let's store the Keycloak admin password in GCP secret

```shell
export PROJECT_ID="YOUR_GPC_PROJECT"
export KEYCLOAK_ADMIN_PASSWORD="SuperSecret123"
./deploy-keycloak-secret.sh
```

Next, let's create a GCP Service account that will be used for the Cloud Run execution.
```shell
export PROJECT_ID="YOUR_GPC_PROJECT"
./deploy-service-acccount.sh
```

Then, let's deploy the Cloud Run container

```shell
export PROJECT_ID="YOUR_GPC_PROJECT"
export REGION="northamerica-northeast1"
export KEYCLOAK_ADMIN="admin"
export KEYCLOAK_ADMIN_PASSWORD="SuperSecret123"
export KEYCLOAK_URL="https://34.23.12.3.sslip.io"
export KEYCLOAK_ADMIN_REALM="master"
export KEYCLOAK_APIGEE_REALM="apigee"
./deploy-cloud-run.sh
```

Finally, let's create the Event-Arc triggers that are used for detecting when apps are created / update

```shell
export PROJECT_ID="YOUR_GPC_PROJECT"
export REGION="northamerica-northeast1"
./deploy-cloud-run-triggers.sh
```


### Not Google Product Clause

This is not an officially supported Google product.